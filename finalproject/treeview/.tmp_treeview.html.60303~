<!DOCTYPE HTML>
<html>
  <head>
    <title>Tree view</title>
    <link type="text/css" rel="stylesheet" href="ex.css?3.2"/>
    <script type="text/javascript" src="../protovis-d3.2.js"></script>
    <script type="text/javascript" src="treeview.js"></script>
    <script type="text/javascript" src="../100nodes.js"></script>
	
    <style type="text/css">

#fig {
  width: 1024px;
  height: 675px;
}

#fulltext {
	font: 1em Gill Sans, Helvetica, Arial, sans-serif;
	position: absolute;
	top: 300px;
	left: 512px;
	width: 256px;
	height: 100px;
	overflow: auto;
	text-align: justify;
	margin: 0;
	padding: 0;
}

    </style>
  </head>
  <body><div id="center"><div id="fig">
    <script type="text/javascript">
/*
 * TODO: 
 * - Tweak the alignment of the center word so the word is in the center of the cones
 * - Add "..." to show words that can't fit on the screen
 * - Remove "i"
 * - Unstem
 * - "sex"
 * - Bigrams
 * - Implement sliding for left bar
 * - change font and background
 * - fix font size of middle word
 * - Tweak the alignment of the full text
 * - Tweak the side columns, start centered but don't grow beyond the top
 */
		
/*
 * There's five parts in the visualization:
 * - Rightmost panel for the origin
 * - Middle panel for the center word
 * - Right panel for the dest word
 * 
 * 
 * There's also two panels in the middle that contain the edges between the words.
 * 
 * I'll use 960 pixels width, 720 height???
 * That should be good enough for the iPad.
 * 
 */
// Setup - some useful methods for arrays
// Stolen from "Javascript, the good parts"
Function.prototype.method = function (name, func) {
    this.prototype[name] = func;
    return this;
};
Array.method('reduce', function (f, value) {
    var i;
    for (i = 0; i < this.length; i += 1) {
        value = f(this[i], value);
    }
    return value;
});


var font = "Gill Sans, Helvetica, Arial, sans-serif"
var column = 64; // Width of a single column
var word = "honest"
var wordHeight = 15
var sh = 675
var runSum = []
var i;
var sum = 0;
var panelBorder = 0;

var inx = pv.Scale.linear(0, pv.max(nodes, function(n) { return n.indegree})).range(0, 2*column)
var outx = pv.Scale.linear(0, pv.max(nodes, function(n) { return n.outdegree})).range(0, 2*column)
var y = pv.Scale.linear(0, nodes.length).range(10, 640) 

var incoming = inedges[word];
var outgoing = outedges[word];

var vis = new pv.Panel()
    .width(960)
    .height(sh)
    .top(0)
    .left(0);

var sliders = vis.add(pv.Panel)
	.width(4*column)
	.top(0)
	.left(0)
	.strokeStyle("#888")
	.lineWidth(panelBorder)

// Setup the layout
var leftmost = vis.add(pv.Panel)
	.width(2*column)
	.top(0)
	.left(4*column)
	.strokeStyle("#888")
	.lineWidth(panelBorder)

var midleft = vis.add(pv.Panel)
	.width(1*column)
	.top(0)
	.left(6*column)
	.strokeStyle("#888")
	.lineWidth(panelBorder)

var midright = vis.add(pv.Panel)
	.width(1*column)
	.top(0)
	.left(13*column)
	.strokeStyle("#888")
	.lineWidth(panelBorder)

var rightmost = vis.add(pv.Panel)
	.width(2*column)
	.top(0)
	.left(14*column)
	.strokeStyle("#888")
	.lineWidth(panelBorder)

var middle = vis.add(pv.Panel)
	.width(6*column)
	.top(0)
	.left(7*column)
	.strokeStyle("#888")
	.lineWidth(panelBorder)
	
// Add the words to the left panel. Sort them by prevalence, 
var funkyincoming = funkysort(incoming)
leftmost.add(pv.Label)
	.data(function() {return funkyincoming})
	.right(0)
	.top(function(d) {return (this.index)*wordHeight })
	.text(function(d) {return d.src})
	.textBaseline("top")
	.textAlign("right")
	.font("1.4em Gill Sans, Helvetica, Arial, sans-serif")

var incomingRunSum = runsum(funkyincoming)
var incomingSum = incomingRunSum[incomingRunSum.length - 1]
midleft.add(pv.Panel)
	.data(function() { return funkyincoming;})
  .add(pv.Line)
  	.data(function(d) { 
		var ret = [
			{x: 0*column, y: (this.parent.index + 0.5)*wordHeight},
			{x: 0.5*column, y: (this.parent.index + 0.5)*wordHeight},
			{x: 0.5*column, y: sh/2 - 200 + (-Math.floor(incomingSum/2) + incomingRunSum[this.parent.index])},
			{x: 1*column, y: sh/2 - 200+ (-Math.floor(incomingSum/2) + incomingRunSum[this.parent.index])},
		]
		return ret})
	.strokeStyle("#DDD")
	.lineWidth(function(_, d) {return d.count})
	.interpolate("basis")
    .left(function(d) {return d.x})
    .top(function(d) {return d.y})

funkyoutgoing = funkysort(outgoing)
rightmost.add(pv.Label)
	.data(function() {return funkyoutgoing})
	.left(0)
	.top(function(d) {return this.index*wordHeight })
	.text(function(d) {return d.dest})
	.textBaseline("top")
	.textAlign("left")
	.font("1.4em Gill Sans, Helvetica, Arial, sans-serif")
	
var outgoingRunSum = runsum(funkyoutgoing)
var outgoingSum = outgoingRunSum[outgoingRunSum.length - 1]
midright.add(pv.Panel)
	.data(function() { return funkyoutgoing })
  .add(pv.Line)
  	.data(function(d) { 
		var ret = [
			{x: 0*column, y: sh/2 - 200 + (-Math.floor(outgoingSum/2) + outgoingRunSum[this.parent.index])},
			{x: 0.5*column, y: sh/2 - 200 + (-Math.floor(outgoingSum/2) + outgoingRunSum[this.parent.index])},
			{x: 0.5*column, y: (this.parent.index + 0.5)*wordHeight},
			{x: 1*column, y: (this.parent.index + 0.5)*wordHeight},
		]
		return ret})
	.strokeStyle("#DDD")
	.lineWidth(function(_, d) {return d.count})
	.interpolate("basis")
    .left(function(d) {return d.x})
    .top(function(d) {return d.y})

// Add marks for the width of the cones
middle.add(pv.Line)
	.data(function() { return [
			{x: 6*column, y: sh/2 - 200 - outgoingSum/2},
			{x: 6*column, y: sh/2 - 200 + outgoingSum/2},]})
	.left(function(d) {return d.x})
    .top(function(d) {return d.y})
	.strokeStyle("#F00")
	.lineWidth(4)
	.antialias(false);

middle.add(pv.Line)
	.data(function() { return [
			{x: 0*column, y: sh/2 - 200 - incomingSum/2},
			{x: 0*column, y: sh/2 - 200 + incomingSum/2},]})
	.left(function(d) {return d.x})
    .top(function(d) {return d.y})
	.strokeStyle("#00F")
	.lineWidth(4)
	.antialias(false);

// Add the words at the center, left and right
middle.add(pv.Label)
	.data(function () {return [word];})
	.left(3*column)
	.top(sh/2 - 200)
	.width(4*column)
	.textBaseline("middle")
	.textAlign("center")
	.font("5em Gill Sans, Helvetica, Arial, sans-serif")

/* The area with top line. */
sliders.add(pv.Area)
    .data(nodes)
	.left(2*column)
    .top(function(d) {return y(this.index)})
    .width(function(d) {return inx(d.indegree)})
    .fillStyle("rgb(121,173,210)")

sliders.add(pv.Area)
    .data(nodes)
	.right(2*column)
    .top(function(d) {return y(this.index)})
    .width(function(d) {return outx(d.outdegree)})
    .fillStyle("rgb(173,121,210)")
    .event("point", function() { 
		word = nodes[this.index].node
		incoming = inedges[word];
		funkyincoming = funkysort(incoming);
		incomingRunSum = runsum(funkyincoming)
		incomingSum = incomingRunSum[incomingRunSum.length - 1]
		
		outgoing = outedges[word];
		funkyoutgoing = funkysort(outgoing);
		outgoingRunSum = runsum(funkyoutgoing)
		outgoingSum = outgoingRunSum[outgoingRunSum.length - 1]
		
		vis.render();
	})
    .event("unpoint", function() { 
	})

sliders.events("all")
    .event("mousedown", pv.Behavior.point().collapse("x"))
//    .event("mouseover", pv.Behavior.point().collapse("x"));

nodes.sort(function(a, b) {return (a.indegree - a.outdegree) - (b.indegree - b.outdegree)})


vis.render();

    </script>
  <div id="fulltext">
  	Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor 
	incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud 
	exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute 
	irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla 
	pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia 
	deserunt mollit anim id est laborum.
  </div>
  </div>
  </div></body>
</html>